<!DOCTYPE  html>
<html>
<head>
    <title>Canvas Test</title>
    <style>
        .canvas-container{
            position: relative;
        }

        .canvas-photo {
            width: 892px;
            height: 637px;
        }

        .lato {
            font-family: 'Lato', sans-serif;
        }

        .creepster {
            font-family: 'Creepster', serif;
        }

        .griffy {
            font-family: 'Griffy', serif;
        }
    </style>

    <script type="text/javascript" src="http://evanw.github.com/glfx.js/glfx.js"></script>
    <script src="wcvj.js"></script>
    <link href="http://fonts.googleapis.com/css?family=Lobster|Rye|Griffy|Creepster|Butcherman|Press+Start+2P" rel="stylesheet" type="text/css">
</head>
<body>
    <h1>Build that canvas</h1>
    <span class="lato">Photobooth</span>
    <span class="griffy">Load this</span>
    <div id="canvas-container" class="canvas-container">
        <canvas id="final" width="1190" height="850" class="canvas-photo"></canvas>
    </div>
</body>
<script>
    var requestAnimFrame = (function(){
		return  window.requestAnimationFrame ||
			window.webkitRequestAnimationFrame ||
			window.mozRequestAnimationFrame    ||
			window.oRequestAnimationFrame      ||
			window.msRequestAnimationFrame     ||
			function( callback ){
				window.setTimeout(callback, 1000 / 60);
			};
	})();

    Settings = function Settings(){
        this.photoTime = 5;
    };

     Layer = function Layer(el, dx, dy){
        this.el = el;
        this.width = el.width;
        this.height = el.height;
        this.x = dx;
        this.y = dy;
        this.done = false;
        this.draw = function(){};
        this.ctx = this.el.getContext('2d');
    };

    Layer.prototype = {
        update: function update(){
            if(!this.done){
                this.draw.apply(this.el, [this.ctx]);
            }

            return this.done;
        },

        addText: function addText(text, font, fontSize, x, y){
           this.ctx.font = fontSize + 'px "' + font + '"';
           this.ctx.fillStyle = "white";
           this.ctx.lineWidth = 6;
           this.clearCanvas();
           this.wrapText(text, x, y, (this.width - x), fontSize + 5)
        },

        addTextTopLeft: function addTextTopLeft(text, font, fontSize, x, y) {
            this.ctx.save();
            this.ctx.textAlign = 'left';
            this.ctx.textBaseline = 'top';
            this.addText(text, font, fontSize, x, y);
            this.ctx.restore();
        },

        addTextBottomRight: function addTextBottomRight(text, font, fontSize, x, y) {
            this.ctx.save();
            this.ctx.textAlign = 'right';
            this.ctx.textBaseline = 'bottom';
            this.addText(text, font, fontSize, x, y);
            this.ctx.restore();
        },

        wrapText: function wrapText(text, x, y, maxWidth, lineHeight) {
            var words = text.split(' ');
            var line = '';

            for (var n =0; n < words.length; n++) {
                var testLine = line + words[n] + ' ';
                var metrics = this.ctx.measureText(testLine);
                var testWidth = metrics.width;
                if (testWidth > maxWidth && n > 0) {
                    this.ctx.strokeText(line, x, y);
                    this.ctx.fillText(line, x, y);
                    line = words[n] + ' ';
                    y += lineHeight;
                }
                else {
                    line = testLine;
                }
            }

            this.ctx.strokeText(line, x, y);
            this.ctx.fillText(line, x, y);
        },

        clearCanvas: function clearCanvas() {
            this.ctx.clearRect(0, 0, this.width, this.height);
        }
     };

    LayeredCanvas = function LayeredCanvas(finalCanvas){
        this.final = finalCanvas;
        this.layers = [];
        this.layerHash = {};
        this.ctx = final.getContext('2d');
    };

    LayeredCanvas.prototype = {
        addLayer: function(el, name){
            this.layers.push(el);
            this.layerHash[name] = this.layers.length - 1;

            return this.layers[this.layers.length];
        },

        getLayerByName: function(name){
            return this.layers[this.layerHash[name]];
        },

        render: function(){
            for(var i=0; i<this.layers.length;i++)
            {
                this.layers[i].update();
                this.ctx.drawImage(this.layers[i].el, this.layers[i].x, this.layers[i].y);
            }
        },

        getImage: function() {
            var img = new Image();
            this.render();
            img.src = this.final.toDataURL();
            return img;
        },

        resetLayers: function resetLayers() {
            for(var i=0; i<this.layers.length;i++)
            {
                this.layers[i].done = false;
            }
        }
    };

    var img = new Image();
    img.src = 'lobster_dog.jpg';
    var canvas = document.getElementById('final');
    var canvas_container = document.getElementById('canvas-container');
    var ctx = canvas.getContext('2d');
    var layered = new LayeredCanvas(canvas);
    var backCanvas = document.createElement('canvas');
    backCanvas.width = 540;
    backCanvas.height = 480;

    var textCanvas = document.createElement('canvas');
    textCanvas.width = 540;
    textCanvas.height = 480;

    var countDown = document.createElement('canvas');
    countDown.width = 1190;
    countDown.height = 850;

    layered.addLayer(new Layer(NewCanvas(1190, 850, "rgb(255,255,255)"), 0, 0), 'Base');
    layered.addLayer(new Layer(NewCanvas(540, 360, "rgb(0,0,0)"), 0, 0), 'Panel1');
    layered.addLayer(new Layer(NewCanvas(640, 360,"rgb(0,0,0)"), 550, 0), 'Panel2');
    layered.addLayer(new Layer(NewCanvas(640, 480, "rgb(0,0,0)"), 0, 370), 'Panel3');
    layered.addLayer(new Layer(backCanvas, 650, 370), 'Background');
    layered.addLayer(new Layer(textCanvas, 650, 370), 'Text');
    layered.addLayer(new Layer(countDown, 0, 0), 'CountDown');

    var cd = layered.getLayerByName('CountDown');

    img.onload = function()
    {
        var background = layered.getLayerByName('Background');
        var ratio = img.width / background.width;
        background.ctx.drawImage(img, 0, 0, img.width / ratio, img.height / ratio) ;
        //background.renderOnce = true;
    }

    requestAnimFrame(FullDraw);

    function FullDraw()
    {
        layered.render();
        requestAnimFrame(FullDraw);
    }

    function NewCanvas(width, height, fill){
        var canv = document.createElement('canvas');
        canv.width = width;
        canv.height = height;
        var cb_ctx = canv.getContext('2d');
        cb_ctx.fillStyle = fill; //"rgb(200,0,0)"
        cb_ctx.fillRect(0,0, width, height);

        return canv;
    }



    var a = wcvj.webcam('a', {glfx: true});
    a.video.addEventListener('canplay', function(e){
        a.setFilter([['ink',[0.4]]]);
        console.log(e);
        function test(ctx){
            ctx.drawImage(a.canvas, 50, 50, 540, 360, 0,0, 540, 360);
        };

        function full(ctx){
            ctx.drawImage(a.canvas, 0, 0);
        }

        layered.getLayerByName('Panel1').draw = test;
        layered.getLayerByName('Panel2').draw = full;
        layered.getLayerByName('Panel3').draw = full;

    });

    function PanelCount(count, panel) {
        if (count === 0) {
            count = 'Cheese!';
        }

        if (panel === 1) {
            layered.getLayerByName('CountDown').addTextBottomRight(count +'', 'Griffy', 50, 510, 340);
        }
         if (panel === 2) {
            layered.getLayerByName('CountDown').addTextBottomRight(count +'', 'Griffy', 50, 1160, 340);
        }
         if (panel === 3) {
            layered.getLayerByName('CountDown').addTextBottomRight(count +'', 'Griffy', 50, 610, 840);
        }
    };

    function photoCountDown(count, panel){
        if(count >= 0 && panel <= 3) {
            PanelCount(count, panel);
            count = count - 1;
            setTimeout(function() {photoCountDown(count, panel)}, 1000);
        }else{
            if (panel <= 3) {
                a.update();
                layered.getLayerByName('Panel' + panel).done = true;
                panel += 1;
                count = 5;
                PanelCount(count, panel);
                count -= 1;
                setTimeout(function() {photoCountDown(count, panel)}, 1000);
            }else{
                layered.getLayerByName('CountDown').clearCanvas();
                document.body.appendChild(layered.getImage());
                layered.getLayerByName('CountDown').addText('Please Wait', 'Griffy', 50, 450, 380);
                setTimeout(photoReset, 3000);

            }
        }
    };

    function photoReset() {
        layered.getLayerByName('CountDown').clearCanvas();
        layered.resetLayers();
    };

</script>
</html>