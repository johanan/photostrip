<!DOCTYPE  html>
<html>
<head>
    <title>Canvas Test</title>
    <style>
        .canvas-container{
            position: relative;
        }

        .canvas-photo {
            width: 892px;
            height: 637px;
        }

        .lato {
            font-family: 'Lato', sans-serif;
        }

        .creepster {
            font-family: 'Creepster', serif;
        }

        .griffy {
            font-family: 'Griffy', serif;
        }

        .rye {
            font-family: 'Rye', serif;
        }

        #start {
            position: absolute;
            top: 300px;
            left: 375px;
            color: #ffffff;
            font-size: 150px;
            text-shadow: 2px 3px 10px #333333;
            cursor: pointer;
        }

        div.hidden, i.hidden {
            display: none;
        }
    </style>

    <script type="text/javascript" src="http://evanw.github.com/glfx.js/glfx.js"></script>
    <script src="wcvj.js"></script>
    <link href="http://fonts.googleapis.com/css?family=Lato|Rye|Griffy|Creepster|Butcherman|Press+Start+2P" rel="stylesheet" type="text/css">
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.1/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//cdnjs.cloudflare.com/ajax/libs/semantic-ui/0.9.3/css/semantic.min.css" rel="stylesheet" type="text/css">
</head>
<body>
    <div class="ui grid">
        <div class="row">
            <div class="column">
                <h1 class="ui center aligned header lato">Photobooth</h1>
                <span class="griffy">Load this</span>
                <select name="filters" id="filters" class="ui dropdown selection"></select>
                <ul id="fonts"></ul>
                <ul id="backgrounds"></ul>
                <input id="greetings" type="text" value="Merry">
            </div>
        </div>
        <div class="row">
            <div class="column">
                <div id="canvas-container" class="canvas-container ui center aligned">
                    <canvas id="final" width="1190" height="850" class="canvas-photo"></canvas>
                    <i id="start" class="fa fa-camera-retro fa-3x"></i>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    var requestAnimFrame = (function(){
		return  window.requestAnimationFrame ||
			window.webkitRequestAnimationFrame ||
			window.mozRequestAnimationFrame    ||
			window.oRequestAnimationFrame      ||
			window.msRequestAnimationFrame     ||
			function( callback ){
				window.setTimeout(callback, 1000 / 60);
			};
	})();

    Settings = {
        photoTime: 5,
        filters: [[[], 'None'],
            [[["ink", [0.3]]], 'Drawn'],
            [[["hexagonalPixelate", [0, 0, 20]]], 'Pixelate'],
            [[["dotScreen", [0, 0, 1.1, 8]]], 'Newspaper'],
            [[["edgeWork", [8]]], 'Edged'],
            [[["hueSaturation", [0, -1]]], 'Black&White'],
            [[["brightnessContrast", [0, 0.65]], ["ink", [0.25]], ["colorHalftone", [0, 0, 0.25, 7.5]]], 'Comics'],
            [[["noise", [0.1]], ["sepia", [1]], ["vignette", [0.5, 0.7]]], 'Old Timey'],
            [[["bulgePinch", [320, 240, 200, 0.7]]], 'Fisheye'],
            [[["bulgePinch", [320, 240, 200, -0.7]]], 'Pinched'],
            [[["brightnessContrast", [0.11, 0.76]], ["hueSaturation", [0, 0.76]]], 'Washed Out']],
        fontChosen: "Rye",
        fontSizeChosen: 37,
        fontOptions: [["Rye", 37], ["Griffy", 48], ["Creepster", 53], ["Butcherman", 41], ["Press Start 2P", 30], ['Lato', 40]],
        bgOptions: ["http://pybooth.s3.amazonaws.com/bgpacks/HD/8126573910_edc2eb805f.jpg", "http://pybooth.s3.amazonaws.com/bgpacks/HD/5307070755_b23cf8fc99.jpg"]
    };

     Layer = function Layer(el, dx, dy){
        this.el = el;
        this.width = el.width;
        this.height = el.height;
        this.x = dx;
        this.y = dy;
        this.done = false;
        this.draw = function(){};
        this.ctx = this.el.getContext('2d');
        this.renderOnce = false;
    };

    Layer.prototype = {
        update: function update(){
            if (!this.done && !this.renderOnce) {
                this.draw.apply(this.el, [this.ctx]);
            }else if (this.renderOnce) {
                this.draw.apply(this.el, [this.ctx]);
                this.done = true;
                this.renderOnce = false;
            }
        },

        addText: function addText(text, font, fontSize, x, y){
           this.renderOnce = false;
           this.ctx.font = fontSize + 'px "' + font + '"';
           this.ctx.fillStyle = "white";
           this.ctx.lineWidth = 10;
           this.ctx.miterLimit = 3;
            //this.ctx.lineJoin = 'circle';
            //this.ctx.lineCap = 'round';
           //this.ctx.strokeStyle = 'black';
           this.clearCanvas();
           this.wrapText(text, x, y, (this.width - x), fontSize + 5);
           this.renderOnce = true;
        },

        addTextTopLeft: function addTextTopLeft(text, font, fontSize, x, y) {
            this.ctx.save();
            this.ctx.textAlign = 'left';
            this.ctx.textBaseline = 'top';
            this.addText(text, font, fontSize, x, y);
            this.ctx.restore();
        },

        addTextBottomRight: function addTextBottomRight(text, font, fontSize, x, y) {
            this.ctx.save();
            this.ctx.textAlign = 'right';
            this.ctx.textBaseline = 'bottom';
            this.addText(text, font, fontSize, x, y);
            this.ctx.restore();
        },

        wrapText: function wrapText(text, x, y, maxWidth, lineHeight) {
            var words = text.split(' ');
            var line = '';

            for (var n =0; n < words.length; n++) {
                var testLine = line + words[n] + ' ';
                var metrics = this.ctx.measureText(testLine);
                var testWidth = metrics.width;
                if (testWidth > maxWidth && n > 0) {
                    this.ctx.strokeText(line, x, y);
                    this.ctx.fillText(line, x, y);
                    line = words[n] + ' ';
                    y += lineHeight;
                }
                else {
                    line = testLine;
                }
            }

            this.ctx.strokeText(line, x, y);
            this.ctx.fillText(line, x, y);
        },

        clearCanvas: function clearCanvas() {
            this.ctx.clearRect(0, 0, this.width, this.height);
        }
     };

    LayeredCanvas = function LayeredCanvas(finalCanvas){
        this.final = finalCanvas;
        this.layers = [];
        this.layerHash = {};
        this.ctx = final.getContext('2d');
    };

    LayeredCanvas.prototype = {
        addLayer: function(el, name){
            this.layers.push(el);
            this.layerHash[name] = this.layers.length - 1;

            return this.layers[this.layers.length];
        },

        getLayerByName: function(name){
            return this.layers[this.layerHash[name]];
        },

        render: function(){
            for(var i=0; i<this.layers.length;i++)
            {
                this.layers[i].update();
                this.ctx.drawImage(this.layers[i].el, this.layers[i].x, this.layers[i].y);
            }
        },

        getPNG: function getPNG() {
            return this.final.toDataURL();
        },

        getJPG: function getJPG(quality) {
            return this.final.toDataURL('image/jpeg', quality);
        },

        getImage: function() {
            var img = new Image();
            this.render();
            img.src = this.final.toDataURL();
            return img;
        },

        resetLayers: function resetLayers() {
            for(var i=0; i<this.layers.length;i++)
            {
                this.layers[i].done = false;
                this.layers[i].renderOnce = false;
            }
        }
    };

    var img = new Image();
    img.src = 'lobster_dog.jpg';
    var canvas = document.getElementById('final');
    var canvas_container = document.getElementById('canvas-container');
    var ctx = canvas.getContext('2d');
    var layered = new LayeredCanvas(canvas);
    var backCanvas = document.createElement('canvas');
    backCanvas.width = 540;
    backCanvas.height = 480;

    var textCanvas = document.createElement('canvas');
    textCanvas.width = 540;
    textCanvas.height = 480;

    var countDown = document.createElement('canvas');
    countDown.width = 1190;
    countDown.height = 850;

    layered.addLayer(new Layer(NewCanvas(1190, 850, "rgb(255,255,255)"), 0, 0), 'Base');
    layered.addLayer(new Layer(NewCanvas(540, 360, "rgb(0,0,0)"), 0, 0), 'Panel1');
    layered.addLayer(new Layer(NewCanvas(640, 360,"rgb(0,0,0)"), 550, 0), 'Panel2');
    layered.addLayer(new Layer(NewCanvas(640, 480, "rgb(0,0,0)"), 0, 370), 'Panel3');
    layered.addLayer(new Layer(backCanvas, 650, 370), 'Background');
    layered.addLayer(new Layer(textCanvas, 650, 370), 'Text');
    layered.addLayer(new Layer(countDown, 0, 0), 'CountDown');

    var cd = layered.getLayerByName('CountDown');

    img.onload = function()
    {
        var background = layered.getLayerByName('Background');
        var ratio = img.width / background.width;
        background.ctx.drawImage(img, 0, 0, img.width / ratio, img.height / ratio) ;
        background.renderOnce = true;
    }

    requestAnimFrame(FullDraw);

    function FullDraw()
    {
        layered.render();
        requestAnimFrame(FullDraw);
    }

    function NewCanvas(width, height, fill){
        var canv = document.createElement('canvas');
        canv.width = width;
        canv.height = height;
        var cb_ctx = canv.getContext('2d');
        cb_ctx.fillStyle = fill; //"rgb(200,0,0)"
        cb_ctx.fillRect(0,0, width, height);

        return canv;
    }



    var a = wcvj.webcam('a', {glfx: true});
    a.video.addEventListener('canplay', function(e){
        a.setFilter([['ink',[0.4]]]);
        console.log(e);
        function test(ctx){
            ctx.drawImage(a.canvas, 50, 50, 540, 360, 0,0, 540, 360);
        };

        function full(ctx){
            ctx.drawImage(a.canvas, 0, 0);
        }

        layered.getLayerByName('Panel1').draw = test;
        layered.getLayerByName('Panel2').draw = full;
        layered.getLayerByName('Panel3').draw = full;

    });

    function PanelCount(count, panel) {
        if (panel === 1) {
            layered.getLayerByName('CountDown').addTextBottomRight(count +'', 'Griffy', 50, 510, 340);
        }
         if (panel === 2) {
            layered.getLayerByName('CountDown').addTextBottomRight(count +'', 'Griffy', 50, 1160, 340);
        }
         if (panel === 3) {
            layered.getLayerByName('CountDown').addTextBottomRight(count +'', 'Griffy', 50, 610, 840);
        }
    };

    function Smile() {
        layered.getLayerByName('CountDown').addText("\uf118", 'FontAwesome', 200, 520, 420);
    };

    function photoCountDown(count, panel){
        if(count > 0 && panel <= 3) {
            PanelCount(count, panel);
            count = count - 1;
            setTimeout(function() {photoCountDown(count, panel)}, 1000);
        }else{
            if (panel <= 3) {
                Smile();
                a.update();
                layered.getLayerByName('Panel' + panel).done = true;
                panel += 1;
                count = Settings.photoTime;
                setTimeout(function() {photoCountDown(count, panel)}, 1000);
            }else{
                layered.getLayerByName('CountDown').clearCanvas();
                autoDownload('PhotoDownload_' + (Math.floor(new Date().getTime() / 10000)) + '.png', layered.getPNG());
                layered.getLayerByName('CountDown').addText('Please Wait', 'Griffy', 50, 450, 380);
                setTimeout(photoReset, 3000);

            }
        }
    };

    function autoDownload(name, imageData) {
        var a = document.createElement('a');
			a.setAttribute('href', imageData);
			a.setAttribute('target', '_blank');
			a.setAttribute('download',  name);
			var e = document.createEvent('MouseEvents');
			e.initEvent('click', true, true);
			a.dispatchEvent(e);
    };

    function photoReset() {
        layered.getLayerByName('CountDown').clearCanvas();
        layered.resetLayers();
        start.classList.toggle('hidden');
    };

    var start = document.getElementById('start'),
    filters = document.getElementById('filters'),
    fontList = document.getElementById(('fonts')),
    greetings = document.getElementById('greetings'),
    backgrounds = document.getElementById(('backgrounds'));

    function loadFilters() {
        for(var i=0; i<Settings.filters.length; i++) {
            filters.options[filters.options.length] = new Option(Settings.filters[i][1], i);
        }
    };

    function loadFonts() {
        for(var i=0;i<Settings.fontOptions.length;i++)
        {
            var li = document.createElement('li');
            li.setAttribute('data-size', Settings.fontOptions[i][1]);
            li.setAttribute('style', 'font-family: "' + Settings.fontOptions[i][0] + '"');
            li.innerHTML = Settings.fontOptions[i][0];
            fontList.appendChild(li);
        }
    };

    function changeGreetingText(font, fontSize) {
        var text = layered.getLayerByName('Text');
        text.addText(greetings.value, font, fontSize, 50, 50);
    };

    function loadBackgrounds() {
        for (var i=0;i<Settings.bgOptions.length;i++) {
            var li = document.createElement('li');
            var img = new Image();
            img.src = Settings.bgOptions[i];
            li.appendChild(img);
            backgrounds.appendChild(li);
        }
    };

    loadFilters();
    loadFonts();
    loadBackgrounds();

    start.addEventListener('click', function(e){
        photoCountDown(Settings.photoTime, 1);
        start.classList.toggle('hidden');
    });

    filters.addEventListener('change', function(e){
        a.setFilter(Settings.filters[filters.selectedIndex][0]);
    });

    fontList.addEventListener('click', function(e){
        if (e.target.tagName === 'LI') {
            console.log(e);
            Settings.fontChosen = e.target.innerHTML;
            Settings.fontSizeChosen = e.target.getAttribute('data-size');
            changeGreetingText(e.target.innerHTML, e.target.getAttribute('data-size'));
        }
    });

    greetings.addEventListener('change', function(e){
        changeGreetingText(Settings.fontChosen, Settings.fontSizeChosen);
    });

    backgrounds.addEventListener('click', function(e){
        if (e.target.tagName === 'IMG') {
            console.log(e.target.src);
        }
    });

</script>
</html>