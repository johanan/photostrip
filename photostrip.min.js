/*! photostrip - v0.5 - 2014-10-19
* Copyright (c) 2014 Joshua Johanan; Licensed  */
function quickGetJSON(a,b,c){var d=new XMLHttpRequest;d.onreadystatechange=function(){4===d.readyState&&200===d.status&&b(JSON.parse(d.responseText)),4===d.readyState&&200!==d.status&&void 0!==c&&c(d.responseText)},d.open("GET",a,!0),d.send()}function NewCanvas(a,b,c){var d=document.createElement("canvas");d.width=a,d.height=b;var e=d.getContext("2d");return e.fillStyle=c,e.fillRect(0,0,a,b),d}var wcvj=window.wcvj||{};wcvj.videoIsSupported=function(){return!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)},wcvj.webglIsSupported=function(){var a=document.createElement("canvas");return!(!window.WebGLRenderingContext||!a.getContext("webgl")&&!a.getContext("experimental-webgl"))},function(a){"use strict";var b=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.oGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,c=window.webkitURL||window.mozURL||window.msURL||window.URL,d=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}();a.webcam=function(e,f){f="undefined"!=typeof f?f:{},f.canvas="undefined"!=typeof f.canvas?f.canvas:!1,f.draw="undefined"!=typeof f.draw?f.draw:!1,f.autoplay="undefined"!=typeof f.autoplay?f.autoplay:!0,f.glfx=void 0!==window.fx&&a.webglIsSupported()?void 0!==typeof f.glfx?f.glfx:!1:!1;var g,h,i,j,k,l;l=[],g=document.getElementById(e),null===g?(g=document.createElement("video"),g.id=e,g.autoplay=f.autoplay,g.innerHTML="Your browser does not support video"):g.autoplay=f.autoplay,f.glfx&&a.webglIsSupported()?h=fx.canvas():f.canvas&&(h=document.createElement("canvas"),i=h.getContext("2d"),j=h.getContext("webgl")||h.getContext("experimental-webgl"),h.innerHTML="Your browser does not support canvas");var m=function(){i.drawImage(g,0,0)};f.draw||(f.draw=m);var n=function(){if(f.glfx){k.loadContentsOf(g),h.draw(k);for(var a=0;a<l.length;a++)h[l[a][0]].apply(h,l[a][1]);h.update()}else f.draw.apply(h,[i,j,g]);d(n)},o=function(a){f.canvas&&(f.draw=a,i.save(),i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,h.width,h.height),i.restore())},p=function(a){l=a},q=function(){f.glfx&&h.update()},r=new CustomEvent("webcamReady",{video:g,canvas:h}),s=function(){(f.canvas||f.glfx)&&(h.width=g.videoWidth,h.height=g.videoHeight),setTimeout(function(){f.glfx&&(k=h.texture(g),n(),h.dispatchEvent(r))},500),f.canvas&&(n(),h.dispatchEvent(r))};return g.addEventListener("canplay",s,!1),b.call(navigator,{video:!0,audio:!1},function(a){void 0!==g.mozSrcObject?g.mozSrcObject=a:g.src=navigator.mozGetUserMedia?a:c?c.createObjectURL(a):a},function(a){var b=new Event("UserMediaError");b.initEvent("UserMediaError",!0,!0),b.UserMediaError=a,g.dispatchEvent(b)}),{video:g,canvas:h,setDraw:o,setFilter:p,update:q}}}(window.wcvj);var extend=function(a,b){var c,d={};for(c in a)Object.prototype.hasOwnProperty.call(a,c)&&(d[c]=a[c]);for(c in b)Object.prototype.hasOwnProperty.call(b,c)&&(d[c]=b[c]);return d},requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}();!function(a){a.LayeredCanvas=function(a){this.final=a,this.layers=[],this.layerHash={},this.ctx=this.final.getContext("2d")},a.LayeredCanvas.prototype={addLayer:function(a,b){return this.layers.push(a),this.layerHash[b]=this.layers.length-1,this.layers[this.layers.length]},getLayerByName:function(a){return this.layers[this.layerHash[a]]},render:function(){for(var a=0;a<this.layers.length;a++)this.layers[a].update(),this.ctx.drawImage(this.layers[a].el,this.layers[a].x,this.layers[a].y)},getPNG:function(){return this.final.toDataURL()},getJPG:function(a){return this.final.toDataURL("image/jpeg",a)},resetLayers:function(){for(var a=0;a<this.layers.length;a++)this.layers[a].done=!1,this.layers[a].renderOnce=!1}}}(window.Josh=window.Josh||{}),function(a){a.Layer=function(a,b,c){this.el=a,this.width=a.width,this.height=a.height,this.x=b,this.y=c,this.done=!1,this.draw=function(){},this.ctx=this.el.getContext("2d"),this.renderOnce=!1},a.Layer.prototype={update:function(){this.done||this.renderOnce?this.renderOnce&&(this.draw.apply(this.el,[this.ctx]),this.done=!0,this.renderOnce=!1):this.draw.apply(this.el,[this.ctx])},addText:function(a,b,c,d,e){this.renderOnce=!1,this.ctx.font=c+'px "'+b+'"',this.ctx.fillStyle="white",this.ctx.lineWidth=10,this.ctx.miterLimit=3,this.clearCanvas(),this.ctx.strokeText(a,d,e),this.ctx.fillText(a,d,e),this.renderOnce=!0},addCenterText:function(a,b,c){this.renderOnce=!1,this.ctx.font=c+'px "'+b+'"',this.ctx.fillStyle="white",this.ctx.lineWidth=10,this.ctx.miterLimit=3,this.ctx.textAlign="left",this.ctx.textBaseline="top",this.clearCanvas(),this.wrapText(a,this.width,this.height,c+5),this.renderOnce=!0},addTextTopLeft:function(a,b,c,d,e){this.ctx.save(),this.ctx.textAlign="left",this.ctx.textBaseline="top",this.addText(a,b,c,d,e),this.ctx.restore()},addTextBottomRight:function(a,b,c,d,e){this.ctx.save(),this.ctx.textAlign="right",this.ctx.textBaseline="bottom",this.addText(a,b,c,d,e),this.ctx.restore()},wrapText:function(a,b,c,d){for(var e=a.split(" "),f="",g=[],h=0,i=0,j=0;j<e.length;j++){var k=f+e[j]+" ",l=this.ctx.measureText(k),m=l.width;m>b&&j>0?(g.push(f),h=i>h?i:h,f=e[j]+" "):(f=k,i=m)}0===h&&(h=i),g.push(f);var n,o;n=(b-h)/2,o=(c-d*g.length)/2;for(var p=0;p<g.length;p++)this.ctx.strokeText(g[p],n,o),this.ctx.fillText(g[p],n,o),o+=d},clearCanvas:function(){this.ctx.clearRect(0,0,this.width,this.height)}}}(window.Josh=window.Josh||{}),function(a){a.AC=function(){"use strict";var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D;return this.init=function(){var E=document.getElementById("webcam-allow");b=document.getElementById("final"),c=document.getElementById("canvas-container"),d=b.getContext("2d"),e=new a.LayeredCanvas(b),j=new a.Layer(new NewCanvas(1190,850,"rgb(255,255,255)"),0,0),k=new a.Layer(new NewCanvas(540,360,"rgb(0,0,0)"),0,0),l=new a.Layer(new NewCanvas(640,360,"rgb(0,0,0)"),550,0),m=new a.Layer(new NewCanvas(640,480,"rgb(0,0,0)"),0,370),f=new a.Layer(new NewCanvas(540,480,"rgb(0,0,0)"),650,370),g=document.createElement("canvas"),h=document.createElement("canvas"),o=document.getElementById("start"),p=document.getElementById("filters"),q=document.getElementById("fonts"),r=document.getElementById("greetings"),s=document.getElementById("backgrounds"),C=document.getElementById("photo-credits"),g.width=540,g.height=480,h.width=1190,h.height=850,e.addLayer(j,"Base"),e.addLayer(k,"Panel1"),e.addLayer(l,"Panel2"),e.addLayer(m,"Panel3"),e.addLayer(f,"Background"),e.addLayer(new a.Layer(g,650,370),"Text"),e.addLayer(new a.Layer(h,0,0),"CountDown"),v=e.getLayerByName("CountDown"),w=e.getLayerByName("Text"),i=function F(){e.render(),requestAnimFrame(F)},t=function(a){var b=a.width/f.width;f.ctx.drawImage(a,0,0,a.width/b,a.height/b),f.renderOnce=!0},u=function G(a){t(a.target),a.target.removeEventListener("load",G)},x=function(a,b){1===b&&v.addTextBottomRight(a+"","Griffy",50,510,340),2===b&&v.addTextBottomRight(a+"","Griffy",50,1160,340),3===b&&v.addTextBottomRight(a+"","Griffy",50,610,840)},y=function(){v.addText("\uf118","FontAwesome",200,520,420)},z=function H(a,b,c){a>0&&3>=b?(x(a,b),a-=1,setTimeout(function(){H(a,b,c)},1e3)):3>=b?(y(),n.update(),e.getLayerByName("Panel"+b).done=!0,b+=1,a=c,setTimeout(function(){H(a,b,c)},1e3)):(v.addText("","Griffy",10,0,0),v.clearCanvas(),e.render(),A("PhotoDownload_"+Math.floor((new Date).getTime()/1e4)+".jpg",e.getJPG(.9)),e.getLayerByName("CountDown").addText("Please Wait","Griffy",50,450,380),setTimeout(B,3e3))}.bind(this),A=function(a,b){var c=document.createElement("a");c.setAttribute("href",b),c.setAttribute("target","_blank"),c.setAttribute("download",a),s.appendChild(c);var d=document.createEvent("MouseEvents");d.initEvent("click",!0,!0),c.dispatchEvent(d)},B=function(){v.clearCanvas(),e.resetLayers(),o.classList.toggle("hidden")},D=function(a){var b=document.createElement("li"),c=new Image;c.src=a[0],b.appendChild(c);var d=document.createElement("a");d.href=a[1].author.url,d.innerText=a[1].author.name,d.target="_blank",b.appendChild(d),C.appendChild(b)},n=wcvj.webcam("a",{glfx:!0}),n.video.addEventListener("canplay",function(){function a(a){a.drawImage(n.canvas,50,50,540,360,0,0,540,360)}function b(a){a.drawImage(n.canvas,0,0)}o.classList.toggle("hidden"),E.classList.add("hidden"),v.clearCanvas(),k.draw=a,l.draw=b,m.draw=b}),this.wireEvents(),this.getSettings("settings.json"),void 0!==location.hash.substring(1)&&this.getSettings(location.hash.substring(1)+".json"),requestAnimFrame(i)},this.initPhotobooth=function(a){this.settings=extend(this.settings,a),this.loadFilters(),this.loadFonts(q),this.loadBackgrounds(),this.setGreeting(this.settings.message)},this.changeGreetingText=function(a,b){w.addCenterText(r.value,a,b)},this.loadFilters=function(){for(;p.options.length>0;)p.remove(0);for(var a=0;a<this.settings.filters.length;a++)p.options[p.options.length]=new Option(this.settings.filters[a][1],a)},this.loadBackgrounds=function(){for(;s.firstChild;)s.removeChild(s.firstChild),C.removeChild(C.firstChild);for(var a=0;a<this.settings.bgOptions.length;a++){var b=document.createElement("li"),c=new Image;c.crossOrigin="",c.src=this.settings.bgOptions[a][0],0===a&&c.addEventListener("load",u),b.appendChild(c),s.appendChild(b),D(this.settings.bgOptions[a])}},this.loadFonts=function(a){for(;a.firstChild;)a.removeChild(a.firstChild);for(var b=0;b<this.settings.fontOptions.length;b++){var c=document.createElement("li");c.setAttribute("data-size",this.settings.fontOptions[b][1]),c.setAttribute("style",'font-family: "'+this.settings.fontOptions[b][0]+'"'),c.innerHTML=this.settings.fontOptions[b][0],a.appendChild(c)}},this.wireEvents=function(){o.addEventListener("click",function(){z(this.settings.photoTime,1,this.settings.photoTime),o.classList.toggle("hidden")}.bind(this)),p.addEventListener("change",function(){n.setFilter(this.settings.filters[p.selectedIndex][0])}.bind(this)),r.addEventListener("change",function(){this.changeGreetingText(this.settings.fontChosen,this.settings.fontSizeChosen)}.bind(this)),s.addEventListener("click",function(a){"IMG"===a.target.tagName&&t(a.target)}),window.addEventListener("hashchange",function(){this.getSettings(location.hash.substring(1)+".json","settings.json")}.bind(this))},this.setGreeting=function(a){r.value=a,this.changeGreetingText(this.settings.fontChosen,this.settings.fontSizeChosen)},this.init(),this},a.AC.prototype.getSettings=function(a){quickGetJSON(a,this.initPhotobooth.bind(this))}}(window.Josh=window.Josh||{});