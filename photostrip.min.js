/*! photostrip - v0.5 - 2013-12-26
* Copyright (c) 2013 Joshua Johanan; Licensed  */
function quickGetJSON(a,b){var c=new XMLHttpRequest;c.onreadystatechange=function(){4===c.readyState&&200===c.status&&b(JSON.parse(c.responseText))},c.open("GET",a,!0),c.send()}function NewCanvas(a,b,c){var d=document.createElement("canvas");d.width=a,d.height=b;var e=d.getContext("2d");return e.fillStyle=c,e.fillRect(0,0,a,b),d}var wcvj=window.wcvj||{};wcvj.videoIsSupported=function(){return!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)},wcvj.webglIsSupported=function(){var a=document.createElement("canvas");return!(!window.WebGLRenderingContext||!a.getContext("webgl")&&!a.getContext("experimental-webgl"))},function(a){"use strict";var b=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.oGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,c=window.webkitURL||window.mozURL||window.msURL||window.URL,d=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}();a.webcam=function(e,f){f="undefined"!=typeof f?f:{},f.canvas="undefined"!=typeof f.canvas?f.canvas:!1,f.draw="undefined"!=typeof f.draw?f.draw:!1,f.autoplay="undefined"!=typeof f.autoplay?f.autoplay:!0,f.glfx=void 0!==window.fx&&a.webglIsSupported()?void 0!==typeof f.glfx?f.glfx:!1:!1;var g,h,i,j,k,l;l=[],g=document.getElementById(e),null===g?(g=document.createElement("video"),g.id=e,g.autoplay=f.autoplay,g.innerHTML="Your browser does not support video"):g.autoplay=f.autoplay,f.glfx&&a.webglIsSupported()?h=fx.canvas():f.canvas&&(h=document.createElement("canvas"),i=h.getContext("2d"),j=h.getContext("webgl")||h.getContext("experimental-webgl"),h.innerHTML="Your browser does not support canvas");var m=function(){i.drawImage(g,0,0)};f.draw||(f.draw=m);var n=function(){if(f.glfx){k.loadContentsOf(g),h.draw(k);for(var a=0;a<l.length;a++)h[l[a][0]].apply(h,l[a][1]);h.update()}else f.draw.apply(h,[i,j,g]);d(n)},o=function(a){f.canvas&&(f.draw=a,i.save(),i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,h.width,h.height),i.restore())},p=function(a){l=a},q=function(){f.glfx&&h.update()},r=new CustomEvent("webcamReady",{video:g,canvas:h}),s=function(){(f.canvas||f.glfx)&&(h.width=g.videoWidth,h.height=g.videoHeight),setTimeout(function(){f.glfx&&(k=h.texture(g),n(),h.dispatchEvent(r))},500),f.canvas&&(n(),h.dispatchEvent(r))};return g.addEventListener("canplay",s,!1),b.call(navigator,{video:!0,audio:!1},function(a){void 0!==g.mozSrcObject?g.mozSrcObject=a:g.src=navigator.mozGetUserMedia?a:c?c.createObjectURL(a):a},function(a){var b=new Event("UserMediaError");b.initEvent("UserMediaError",!0,!0),b.UserMediaError=a,g.dispatchEvent(b)}),{video:g,canvas:h,setDraw:o,setFilter:p,update:q}}}(window.wcvj);var requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}();!function(a){a.LayeredCanvas=function(a){this.final=a,this.layers=[],this.layerHash={},this.ctx=this.final.getContext("2d")},a.LayeredCanvas.prototype={addLayer:function(a,b){return this.layers.push(a),this.layerHash[b]=this.layers.length-1,this.layers[this.layers.length]},getLayerByName:function(a){return this.layers[this.layerHash[a]]},render:function(){for(var a=0;a<this.layers.length;a++)this.layers[a].update(),this.ctx.drawImage(this.layers[a].el,this.layers[a].x,this.layers[a].y)},getPNG:function(){return this.final.toDataURL()},getJPG:function(a){return this.final.toDataURL("image/jpeg",a)},getImage:function(){var a=new Image;return this.render(),a.src=this.final.toDataURL(),a},resetLayers:function(){for(var a=0;a<this.layers.length;a++)this.layers[a].done=!1,this.layers[a].renderOnce=!1}}}(window.Josh=window.Josh||{}),function(a){a.Layer=function(a,b,c){this.el=a,this.width=a.width,this.height=a.height,this.x=b,this.y=c,this.done=!1,this.draw=function(){},this.ctx=this.el.getContext("2d"),this.renderOnce=!1},a.Layer.prototype={update:function(){this.done||this.renderOnce?this.renderOnce&&(this.draw.apply(this.el,[this.ctx]),this.done=!0,this.renderOnce=!1):this.draw.apply(this.el,[this.ctx])},addText:function(a,b,c,d,e){this.renderOnce=!1,this.ctx.font=c+'px "'+b+'"',this.ctx.fillStyle="white",this.ctx.lineWidth=10,this.ctx.miterLimit=3,this.clearCanvas(),this.ctx.strokeText(a,d,e),this.ctx.fillText(a,d,e),this.renderOnce=!0},addCenterText:function(a,b,c){this.renderOnce=!1,this.ctx.font=c+'px "'+b+'"',this.ctx.fillStyle="white",this.ctx.lineWidth=10,this.ctx.miterLimit=3,this.ctx.textAlign="left",this.ctx.textBaseline="top",this.clearCanvas(),this.wrapText(a,this.width,this.height,c+5),this.renderOnce=!0},addTextTopLeft:function(a,b,c,d,e){this.ctx.save(),this.ctx.textAlign="left",this.ctx.textBaseline="top",this.addText(a,b,c,d,e),this.ctx.restore()},addTextBottomRight:function(a,b,c,d,e){this.ctx.save(),this.ctx.textAlign="right",this.ctx.textBaseline="bottom",this.addText(a,b,c,d,e),this.ctx.restore()},wrapText:function(a,b,c,d){for(var e=a.split(" "),f="",g=[],h=0,i=0,j=0;j<e.length;j++){var k=f+e[j]+" ",l=this.ctx.measureText(k),m=l.width;m>b&&j>0?(g.push(f),h=i>h?i:h,f=e[j]+" "):(f=k,i=m)}0===h&&(h=i),g.push(f);var n,o;n=(b-h)/2,o=(c-d*g.length)/2;for(var p=0;p<g.length;p++)this.ctx.strokeText(g[p],n,o),this.ctx.fillText(g[p],n,o),o+=d},clearCanvas:function(){this.ctx.clearRect(0,0,this.width,this.height)}}}(window.Josh=window.Josh||{}),function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C;a.AC=function(){"use strict";j=this,this.getSettings()},a.AC.prototype.getSettings=function(){quickGetJSON("settings.json",function(a){j.settings=a,j.init()})},a.AC.prototype.init=function(){b=document.getElementById("webcam-allow"),c=document.getElementById("final"),d=document.getElementById("canvas-container"),e=c.getContext("2d"),f=new a.LayeredCanvas(c),l=new a.Layer(new NewCanvas(1190,850,"rgb(255,255,255)"),0,0),m=new a.Layer(new NewCanvas(540,360,"rgb(0,0,0)"),0,0),n=new a.Layer(new NewCanvas(640,360,"rgb(0,0,0)"),550,0),o=new a.Layer(new NewCanvas(640,480,"rgb(0,0,0)"),0,370),g=new a.Layer(new NewCanvas(540,480,"rgb(0,0,0)"),650,370),h=document.createElement("canvas"),i=document.createElement("canvas"),q=document.getElementById("start"),r=document.getElementById("filters"),s=document.getElementById("fonts"),t=document.getElementById("greetings"),u=document.getElementById("backgrounds"),h.width=540,h.height=480,i.width=1190,i.height=850,f.addLayer(l,"Base"),f.addLayer(m,"Panel1"),f.addLayer(n,"Panel2"),f.addLayer(o,"Panel3"),f.addLayer(g,"Background"),f.addLayer(new a.Layer(h,650,370),"Text"),f.addLayer(new a.Layer(i,0,0),"CountDown"),w=f.getLayerByName("CountDown"),x=f.getLayerByName("Text"),k=function D(){f.render(),requestAnimFrame(D)},v=function(a){var b=a.width/g.width;g.ctx.drawImage(a,0,0,a.width/b,a.height/b),g.renderOnce=!0},y=function(a,b){1===b&&w.addTextBottomRight(a+"","Griffy",50,510,340),2===b&&w.addTextBottomRight(a+"","Griffy",50,1160,340),3===b&&w.addTextBottomRight(a+"","Griffy",50,610,840)},z=function(){w.addText("ï„˜","FontAwesome",200,520,420)},A=function E(a,b){a>0&&3>=b?(y(a,b),a-=1,setTimeout(function(){E(a,b)},1e3)):3>=b?(z(),p.update(),f.getLayerByName("Panel"+b).done=!0,b+=1,a=j.settings.photoTime,setTimeout(function(){E(a,b)},1e3)):(w.addText("","Griffy",10,0,0),w.clearCanvas(),f.render(),B("PhotoDownload_"+Math.floor((new Date).getTime()/1e4)+".jpg",f.getJPG(.9)),f.getLayerByName("CountDown").addText("Please Wait","Griffy",50,450,380),setTimeout(C,3e3))},B=function(a,b){var c=document.createElement("a");c.setAttribute("href",b),c.setAttribute("target","_blank"),c.setAttribute("download",a),u.appendChild(c);var d=document.createEvent("MouseEvents");d.initEvent("click",!0,!0),c.dispatchEvent(d)},C=function(){w.clearCanvas(),f.resetLayers(),q.classList.toggle("hidden")},requestAnimFrame(k),p=wcvj.webcam("a",{glfx:!0}),p.video.addEventListener("canplay",function(){function a(a){a.drawImage(p.canvas,50,50,540,360,0,0,540,360)}function c(a){a.drawImage(p.canvas,0,0)}q.classList.toggle("hidden"),b.classList.add("hidden"),w.clearCanvas(),m.draw=a,n.draw=c,o.draw=c}),this.loadFilters(),this.loadBackgrounds(),this.loadFonts(),this.wireEvents()},a.AC.prototype.changeGreetingText=function(a,b){x.addCenterText(t.value,a,b)},a.AC.prototype.loadFilters=function(){for(var a=0;a<this.settings.filters.length;a++)r.options[r.options.length]=new Option(this.settings.filters[a][1],a)},a.AC.prototype.loadBackgrounds=function(){for(var a=0;a<this.settings.bgOptions.length;a++){var b=document.createElement("li"),c=new Image;c.crossOrigin="",c.src=this.settings.bgOptions[a],b.appendChild(c),u.appendChild(b)}},a.AC.prototype.loadFonts=function(){for(var a=0;a<this.settings.fontOptions.length;a++){var b=document.createElement("li");b.setAttribute("data-size",this.settings.fontOptions[a][1]),b.setAttribute("style",'font-family: "'+this.settings.fontOptions[a][0]+'"'),b.innerHTML=this.settings.fontOptions[a][0],s.appendChild(b)}},a.AC.prototype.wireEvents=function(){q.addEventListener("click",function(){A(j.settings.photoTime,1),q.classList.toggle("hidden")}),r.addEventListener("change",function(){p.setFilter(j.settings.filters[r.selectedIndex][0])}),t.addEventListener("change",function(){j.changeGreetingText(j.settings.fontChosen,j.settings.fontSizeChosen)}),u.addEventListener("click",function(a){"IMG"===a.target.tagName&&v(a.target)})}}(window.Josh=window.Josh||{});