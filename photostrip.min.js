/*! photostrip - v0.8.0 - 2015-05-27
* Copyright (c) 2015 Joshua Johanan; Licensed  */
function quickGetJSON(a,b,c){var d=new XMLHttpRequest;d.onreadystatechange=function(){4===d.readyState&&200===d.status&&b(JSON.parse(d.responseText)),4===d.readyState&&200!==d.status&&void 0!==c&&c(d.responseText)},d.open("GET",a,!0),d.send()}function NewCanvas(a,b,c){var d=document.createElement("canvas");d.width=a,d.height=b;var e=d.getContext("2d");return e.fillStyle=c,e.fillRect(0,0,a,b),d}var wcvj=window.wcvj||{};wcvj.videoIsSupported=function(){return!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)},wcvj.webglIsSupported=function(){var a=document.createElement("canvas");return!(!window.WebGLRenderingContext||!a.getContext("webgl")&&!a.getContext("experimental-webgl"))},function(a){"use strict";var b=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.oGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,c=window.webkitURL||window.mozURL||window.msURL||window.URL,d=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}();a.webcam=function(e,f){f="undefined"!=typeof f?f:{},f.canvas="undefined"!=typeof f.canvas?f.canvas:!1,f.draw="undefined"!=typeof f.draw?f.draw:!1,f.autoplay="undefined"!=typeof f.autoplay?f.autoplay:!0,f.resolution="undefined"!=typeof f.resolution?f.resolution:"default",void 0!==window.fx&&a.webglIsSupported()?f.glfx=void 0!==typeof f.glfx?f.glfx:!1:f.glfx=!1;var g,h,i,j,k,l;l=[],g=document.getElementById(e),null===g?(g=document.createElement("video"),g.id=e,g.autoplay=f.autoplay,g.innerHTML="Your browser does not support video"):g.autoplay=f.autoplay,f.glfx&&a.webglIsSupported()?h=fx.canvas():f.canvas&&(h=document.createElement("canvas"),i=h.getContext("2d"),j=h.getContext("webgl")||h.getContext("experimental-webgl"),h.innerHTML="Your browser does not support canvas");var m={"1080p":{mandatory:{minWidth:"1920",minHeight:"1080"}},UXGA:{mandatory:{minWidth:"1600",minHeight:"1200"}},"720p":{mandatory:{minWidth:"1280",minHeight:"720"}},SVGA:{mandatory:{minWidth:"800",minHeight:"600"}},VGA:{mandatory:{minWidth:"640",minHeight:"480"}},"default":!0},n="string"==typeof f.resolution?m[f.resolution]:f.resolution;void 0===n&&(n=m["default"]);var o=function(){i.drawImage(g,0,0)};f.draw||(f.draw=o);var p=function(){if(f.glfx){k.loadContentsOf(g),h.draw(k);for(var a=0;a<l.length;a++)h[l[a][0]].apply(h,l[a][1]);h.update()}else f.draw.apply(h,[i,j,g]);d(p)},q=function(a){f.canvas&&(f.draw=a,i.save(),i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,h.width,h.height),i.restore())},r=function(a){l=a},s=function(){f.glfx&&h.update()},t=function(){(f.canvas||f.glfx)&&(h.width=g.videoWidth,h.height=g.videoHeight),setTimeout(function(){f.glfx&&(k=h.texture(g),p())},500),f.canvas&&p()},u=function(){null!==g.src&&(g.pause(),g.src="",v.stop())};g.addEventListener("canplay",t,!1);var v;return b.call(navigator,{video:n,audio:!1},function(a){v=a,void 0!==g.mozSrcObject?g.mozSrcObject=v:navigator.mozGetUserMedia?g.src=v:c?g.src=c.createObjectURL(v):g.src=v},function(a){var b=document.createEvent("Event");b.initEvent("UserMediaError",!0,!0),b.UserMediaError=a,g.dispatchEvent(b)}),{video:g,canvas:h,setDraw:q,setFilter:r,update:s,killStream:u}}}(window.wcvj);var extend=function(a,b){var c,d={};for(c in a)Object.prototype.hasOwnProperty.call(a,c)&&(d[c]=a[c]);for(c in b)Object.prototype.hasOwnProperty.call(b,c)&&(d[c]=b[c]);return d},requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}();!function(a){a.LayeredCanvas=function(a){this["final"]=a,this.layers=[],this.layerHash={},this.ctx=this["final"].getContext("2d")},a.LayeredCanvas.prototype={addLayer:function(a,b){return this.layers.push(a),this.layerHash[b]=this.layers.length-1,this.layers[this.layers.length]},getLayerByName:function(a){return this.layers[this.layerHash[a]]},render:function(){for(var a=0;a<this.layers.length;a++)this.layers[a].update(),this.ctx.drawImage(this.layers[a].el,this.layers[a].x,this.layers[a].y)},getPNG:function(){return this["final"].toDataURL()},getJPG:function(a){return this["final"].toDataURL("image/jpeg",a)},resetLayers:function(){for(var a=0;a<this.layers.length;a++)this.layers[a].done=!1,this.layers[a].renderOnce=!1}}}(window.Josh=window.Josh||{}),function(a){a.Layer=function(a,b,c){this.el=a,this.width=a.width,this.height=a.height,this.x=b,this.y=c,this.done=!1,this.draw=function(){},this.ctx=this.el.getContext("2d"),this.renderOnce=!1},a.Layer.prototype={update:function(){this.done||this.renderOnce?this.renderOnce&&(this.draw.apply(this.el,[this.ctx]),this.done=!0,this.renderOnce=!1):this.draw.apply(this.el,[this.ctx])},addText:function(a,b,c,d,e){this.renderOnce=!1,this.ctx.font=c+'px "'+b+'"',this.ctx.fillStyle="white",this.ctx.lineWidth=10,this.ctx.miterLimit=2,this.clearCanvas(),this.ctx.strokeText(a,d,e),this.ctx.fillText(a,d,e),this.renderOnce=!0},addCenterText:function(a,b,c){this.renderOnce=!1,this.ctx.font=c+'px "'+b+'"',this.ctx.fillStyle="white",this.ctx.lineWidth=10,this.ctx.miterLimit=2,this.ctx.textAlign="left",this.ctx.textBaseline="top",this.clearCanvas(),this.wrapText(a,this.width-100,this.height,c+5,50),this.renderOnce=!0},addTextTopLeft:function(a,b,c,d,e){this.ctx.save(),this.ctx.textAlign="left",this.ctx.textBaseline="top",this.addText(a,b,c,d,e),this.ctx.restore()},addTextBottomRight:function(a,b,c,d,e){this.ctx.save(),this.ctx.textAlign="right",this.ctx.textBaseline="bottom",this.addText(a,b,c,d,e),this.ctx.restore()},wrapText:function(a,b,c,d,e){for(var f=a.split(" "),g="",h=[],i=0,j=0,k=0;k<f.length;k++){var l=g+f[k]+" ",m=this.ctx.measureText(l),n=m.width;n>b&&k>0?(h.push(g),i=j>i?j:i,g=f[k]+" "):(g=l,j=n)}0===i&&(i=j),h.push(g);var o,p;o=(b-i)/2+e,p=(c-d*h.length)/2;for(var q=0;q<h.length;q++)this.ctx.strokeText(h[q],o,p),this.ctx.fillText(h[q],o,p),p+=d},clearCanvas:function(){this.ctx.clearRect(0,0,this.width,this.height)}}}(window.Josh=window.Josh||{}),function(a){a.AC=function(){"use strict";var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E=2030,F=1450,G=720,H=740,I=1280,J=10,K=10,L=50;return this.init=function(){var M=document.getElementById("webcam-allow");b=document.getElementById("final"),c=document.getElementById("canvas-container"),d=b.getContext("2d"),e=new a.LayeredCanvas(b),j=new a.Layer(new NewCanvas(E,F,"rgb(255,255,255)"),0,0),k=new a.Layer(new NewCanvas(H,G,"rgb(0,0,0)"),0,0),l=new a.Layer(new NewCanvas(I,G,"rgb(0,0,0)"),H+J,0),m=new a.Layer(new NewCanvas(I,G,"rgb(0,0,0)"),0,G+K),f=new a.Layer(new NewCanvas(H,G,"rgb(0,0,0)"),I+J,G+K),g=document.createElement("canvas"),h=document.createElement("canvas"),o=document.getElementById("start"),p=document.getElementById("filters"),q=document.getElementById("fonts"),r=document.getElementById("greetings"),s=document.getElementById("backgrounds"),C=document.getElementById("photo-credits"),g.width=H,g.height=G,h.width=400,h.height=400,e.addLayer(j,"Base"),e.addLayer(k,"Panel1"),e.addLayer(l,"Panel2"),e.addLayer(m,"Panel3"),e.addLayer(f,"Background"),e.addLayer(new a.Layer(g,I+J,G+K),"Text"),e.addLayer(new a.Layer(h,H-h.width-L,G-h.width-L),"CountDown"),v=e.getLayerByName("CountDown"),w=e.getLayerByName("Text"),i=function N(){e.render(),requestAnimFrame(N)},t=function(a){var b=a.width/f.width;f.ctx.drawImage(a,0,0,a.width/b,a.height/b),f.renderOnce=!0},u=function O(a){t(a.target),a.target.removeEventListener("load",O)},x=function(a,b){var c=this.getPanelBounds(b);v.x=c.x+c.w-h.width,v.y=c.y+c.h-h.width,v.addTextBottomRight(a+"","Griffy",50,h.width-L,h.width-L)}.bind(this),this.getPanelBounds=function(a){var b=e.getLayerByName("Panel"+a);return{x:b.x,y:b.y,w:b.width,h:b.height}},y=function(a){var b=this.getPanelBounds(a);v.x=b.x+b.w/2-v.width/2,v.y=b.y+b.h/2-v.width/2,v.addText("\uf118","FontAwesome",200,100,300)}.bind(this),z=function P(a,b,c){a>0&&3>=b?(e.getLayerByName("Panel"+b).done=!1,x(a,b),a-=1,setTimeout(function(){P(a,b,c)},1e3)):3>=b?(y(b),n.update(),e.getLayerByName("Panel"+b).done=!0,b+=1,a=c,setTimeout(function(){P(a,b,c)},1e3)):(v.addText("","Griffy",10,0,0),v.clearCanvas(),e.render(),A("PhotoDownload_"+Math.floor((new Date).getTime()/1e4)+".jpg",e.getJPG(.9)),v.addText("Please Wait","Griffy",50,100,300),setTimeout(B,3e3))}.bind(this),A=function(a,b){var c=document.createElement("a");c.setAttribute("href",b),c.setAttribute("target","_blank"),c.setAttribute("download",a);var d=document.createEvent("MouseEvents");d.initEvent("click",!0,!0),c.dispatchEvent(d)},B=function(){v.clearCanvas(),e.resetLayers(),o.classList.remove("hidden"),l.done=!0,m.done=!0},D=function(a){var b=document.createElement("li"),c=new Image;c.src=a[0],b.appendChild(c);var d=document.createElement("a");d.href=a[1].author.url,d.innerText=a[1].author.name,d.target="_blank",b.appendChild(d),C.appendChild(b)},n=wcvj.webcam("a",{glfx:!0,resolution:"720p"}),n.video.addEventListener("canplay",function(){function a(a){a.drawImage(n.canvas,200,0,H,G,0,0,H,G)}function b(a){a.drawImage(n.canvas,0,0)}o.classList.toggle("hidden"),M.classList.add("hidden"),v.clearCanvas(),k.draw=a,l.draw=b,m.draw=b,setTimeout(B,3e3)}),this.wireEvents(),this.getSettings("settings.json"),void 0!==location.hash.substring(1)&&this.getSettings(location.hash.substring(1)+".json"),requestAnimFrame(i)},this.initPhotobooth=function(a){this.settings=extend(this.settings,a),this.loadFilters(),this.loadFonts(q,function(){this.setGreeting(this.settings.message)}.bind(this)),this.loadBackgrounds()},this.changeGreetingText=function(a,b){w.addCenterText(r.value,a,b)},this.loadFilters=function(){for(;p.options.length>0;)p.remove(0);for(var a=0;a<this.settings.filters.length;a++)p.options[p.options.length]=new Option(this.settings.filters[a][1],a)},this.loadBackgrounds=function(){for(;s.firstChild;)s.removeChild(s.firstChild),C.removeChild(C.firstChild);for(var a=0;a<this.settings.bgOptions.length;a++){var b=document.createElement("li"),c=new Image;c.crossOrigin="",c.src=this.settings.bgOptions[a][0],0===a&&c.addEventListener("load",u),b.appendChild(c),s.appendChild(b),D(this.settings.bgOptions[a])}},this.loadFonts=function(a,b){for(;a.firstChild;)a.removeChild(a.firstChild);for(var c=0;c<this.settings.fontOptions.length;c++){var d=document.createElement("li");d.setAttribute("data-size",this.settings.fontOptions[c][1]),d.setAttribute("style",'font-family: "'+this.settings.fontOptions[c][0]+'"'),d.innerHTML=this.settings.fontOptions[c][0],a.appendChild(d)}setTimeout(b,1e3)},this.wireEvents=function(){o.addEventListener("click",function(){z(this.settings.photoTime,1,this.settings.photoTime),o.classList.toggle("hidden")}.bind(this)),p.addEventListener("change",function(){n.setFilter(this.settings.filters[p.selectedIndex][0])}.bind(this)),r.addEventListener("change",function(){this.changeGreetingText(this.settings.fontChosen,this.settings.fontSizeChosen)}.bind(this)),s.addEventListener("click",function(a){"IMG"===a.target.tagName&&t(a.target)}),window.addEventListener("hashchange",function(){this.getSettings(location.hash.substring(1)+".json","settings.json")}.bind(this))},this.setGreeting=function(a){r.className=this.settings.fontChosen,r.value=a,this.changeGreetingText(this.settings.fontChosen,this.settings.fontSizeChosen)},this.init(),this},a.AC.prototype.getSettings=function(a){quickGetJSON(a,this.initPhotobooth.bind(this))}}(window.Josh=window.Josh||{});